Ãšvod nÃ¡sledujÃ­cÃ­ kapitoly struÄnÄ› popisuje vznik a historii souborovÃ©ho sytÃ©mu ZFS. Zbytek tÃ©to kapitoly pÅ™edstavuje strukturu ZFS, jeho zÃ¡kladnÃ­ stavebnÃ­ kameny a nÄ›kterÃ© zajÃ­mavÃ© principy, kterÃ© tento souborovÃ½ systÃ©m vyuÅ¾Ã­vÃ¡. Pro nÃ¡zornost jsou v~tÃ©to kapitole uvedeny praktickÃ© ukÃ¡zky pÅ™Ã­kazÅ¯ slouÅ¾Ã­cÃ­ k~administraci ZFS.

\section{Ãšvod}
    %NICM MOC
    SouborovÃ½ systÃ©m Zettabyte byl pÅ¯vodnÄ› vyvinut spoleÄnostÃ­ Sun Microsystems a nÃ¡slednÄ› integrovÃ¡n do operaÄnÃ­ho systÃ©mÅ¯ Solaris od stejnojmennÃ© spoleÄnosti.
    Jak uÅ¾ to tak v~dneÅ¡nÃ­m svÄ›tÄ› bÃ½vÃ¡ v~roce 2010 spoleÄnost Oracle akvizicÃ­ spoleÄnosti Sun Microsystems zÃ­skala operaÄnÃ­ systÃ©m Solaris a tÃ­m i vlastnictvÃ­ ZFS \cite{suns}. V~dneÅ¡nÃ­ dobÄ› tedy veÅ¡kerÃ½ vÃ½voj a podpora pro tyto systÃ©my pochÃ¡zÃ­ prÃ¡vÄ› od firmy Oracle. OficiÃ¡lnÃ­ dokumenty a nÃ¡vody od tÃ©to firmy byly hlavnÃ­m zdrojem informacÃ­ pro tuto bakalÃ¡Å™skou prÃ¡ci \cite{guide}.

    SouborovÃ½ systÃ©m ZFS byl pÅ¯vodnÄ› navrhnut pro pouÅ¾itÃ­ ÄistÄ› v~operaÄnÃ­m systÃ©mu Solaris, s~ÄÃ­mÅ¾ se pojily i nÃ¡sledujÃ­cÃ­ poÅ¾adavky pro jeho provoz \cite{requirements}:
    \begin{itemize}
      \item Architektura procesoru SPARC nebo x86
      \item OperaÄnÃ­ systÃ©m Solaris 10 6/06 nebo novÄ›jÅ¡Ã­
      \item MinimÃ¡lnÃ­ mÃ­sto na disku 128 MB
      \item MinimÃ¡lnÃ­ mÃ­sto pro vytvoÅ™enÃ­ poolu 64 MB
      \item Pro optimÃ¡lnÃ­ vÃ½kon ZFS alespoÅˆ 1 GB operaÄnÃ­ pamÄ›ti
    \end{itemize}

    DÃ­ky zveÅ™ejnÄ›nÃ­ zdrojovÃ½ch kÃ³dÅ¯ ZFS, doÅ¡lo k~adaptaci souborovÃ©ho systÃ©mu i na jinÃ© operaÄnÃ­ systÃ©my neÅ¾ je Solaris. HlavnÃ­m pÅ™Ã­kladem jsou systÃ©my s~LinuxovÃ½m jÃ¡drem jako je napÅ™Ã­klad Debian, Fedora nebo CentOS.

\section{Struktura}
VÄ›tÅ¡ina tradiÄnÃ­ch souborovÃ½ch systÃ©mÅ¯ se vÃ¡Å¾e na jedno konkrÃ©tnÃ­ zaÅ™Ã­zenÃ­. Aby bylo moÅ¾nÃ© spojit se souborovÃ½m systÃ©mem vÃ­ce zaÅ™Ã­zenÃ­, byl zaveden tzv. volume manager, kterÃ½ souborovÃ©mu systÃ©mu poskytoval iluzi, Å¾e se jednÃ¡ o~samostatnÃ© zaÅ™Ã­zenÃ­ \cite{traditional}. Ve skuteÄnosti se pod touto vrstvou mÅ¯Å¾e skrÃ½vat vÃ­ce diskÅ¯, kterÃ© se tvÃ¡Å™Ã­ jako jeden. ZFS se v~tomto smÄ›ru vydalo svojÃ­ vlastnÃ­ cestou a zaÅ™Ã­zenÃ­ agreguje do takzvanÃ½ch poolÅ¯, kterÃ© slouÅ¾Ã­ jako datovÃ½ zÃ¡klad pro jednotlivÃ© souborovÃ© systÃ©my.
\begin{figure}
    \centering
    \includegraphics[scale=0.8]{agregation.pdf}
    \caption{Agregace zaÅ™Ã­zenÃ­ do poolu}
    \label{agregation}
\end{figure}
\section{Pool}
SouborovÃ½ systÃ©m ZFS se sklÃ¡dÃ¡ ze dvou hlavnÃ­ch stavebnÃ­ch kamenÅ¯. PrvnÃ­m z~nich je tzv. pool. V~terminologii ZFS je to logickÃ© sdruÅ¾enÃ­ virtuÃ¡lnÃ­ch zaÅ™Ã­zenÃ­, kterÃ© popisuje rozloÅ¾enÃ­ a fyzickÃ© vlastnosti tÄ›chto zaÅ™Ã­zenÃ­ \cite{terminology}. Pool je tedy spojenÃ­ fyzickÃ½ch nebo virtuÃ¡lnÃ­ch zaÅ™Ã­zenÃ­, kterÃ© poskytuje zÃ¡klad pro souborovÃ© systÃ©my ZFS.

SouborovÃ© systÃ©my v~ZFS se uÅ¾ nevÃ¡Å¾Ã­ pÅ™Ã­mo na konkrÃ©tnÃ­ fyzickÃ© zaÅ™Ã­zenÃ­, jak tomu bylo dÅ™Ã­ve, ale na pool jako celek. HistorickÃ© spojenÃ­ souborovÃ©ho systÃ©mu s~konkrÃ©tnÃ­m fyzickÃ½m zaÅ™Ã­zenÃ­m pÅ™inÃ¡Å¡elo mnohÃ¡ omezenÃ­. NapÅ™Ã­klad pokud jsme souborovÃ½ systÃ©m chtÄ›li rozÅ¡Ã­Å™it, museli jsme ho celÃ½ znovu vytvoÅ™it. Tato operace mohla bÃ½t ÄasovÄ› nÃ¡roÄnÃ¡, ale v~ZFS tomu tak nenÃ­.
\subsection{Vlastnosti poolu}
ZFS si o~kaÅ¾dÃ©m vytvoÅ™enÃ©m poolu udrÅ¾uje informace, kterÃ© pouÅ¾Ã­vÃ¡ pro sprÃ¡vu. KaÅ¾dÃ½ pool mÃ¡ seznam vlastnostÃ­, kterÃ© ho popisujÃ­ a jednoznaÄnÄ› urÄujÃ­.
HlavnÃ­m identifikÃ¡torem poolu je jeho jmÃ©no. Toto jmÃ©no musÃ­ bÃ½t v~kontextu celÃ©ho ZFS unikÃ¡tnÃ­, protoÅ¾e se pouÅ¾Ã­vÃ¡ v~pÅ™Ã­kazech manipulujÃ­cÃ­ch s~danÃ½m poolem.

Vlastnosti mÅ¯Å¾eme rozdÄ›lit na dvÄ› skupiny. Na jednÃ© stranÄ› jsou statickÃ© vlastnosti, kterÃ© popisujÃ­ stav poolu a nedajÃ­ se zmÄ›nit pÅ™Ã­mo. Jsou tzv. read-only. Pod tÃ­mto druhem vlastnostÃ­ si mÅ¯Å¾eme pÅ™edstavit informace tÃ½kajÃ­cÃ­ se ÃºloÅ¾nÃ©ho prostoru jako napÅ™Ã­klad velikost poolu, obsazenÃ¡ kapacita nebo volnÃ© mÃ­sto. Velikost poolu nemÅ¯Å¾eme zmÄ›nit pÅ™Ã­mo nastavenÃ­m odpovÃ­dajÃ­cÃ­ vlastnosti na jinou hodnotu, ale mÅ¯Å¾eme pÅ™idat do poolu dalÅ¡Ã­ zdroj. ZFS tento krok rozpoznÃ¡ a souvisejÃ­cÃ­ vlastnosti upravÃ­.

Na druhÃ© stranÄ› jsou vlastnosti, kterÃ© mÅ¯Å¾eme mÄ›nit dynamicky. NÄ›kterÃ© z~tÄ›chto vlastnostÃ­ se dajÃ­ nastavovat pouze v~okamÅ¾iku, kdy danÃ½ pool vytvÃ¡Å™Ã­me nebo importujeme. Nastavit mÅ¯Å¾eme napÅ™Ã­klad vlastnost \emph{read-only}. Tato vlastnost zajistÃ­, Å¾e od doby, kdy byla nastavena, lze z~danÃ©ho poolu data pouze ÄÃ­st a nikoliv data zapisovat. DalÅ¡Ã­ zajÃ­mavou vlastnostÃ­ je vlastnost \emph{bootfs}, kterÃ¡ odkazuje na souborovÃ½ systÃ©m uvnitÅ™ poolu, kterÃ½ slouÅ¾Ã­ pro naÄÃ­tÃ¡nÃ­ operaÄnÃ­ho systÃ©mu. ManuÃ¡lnÃ­ nastavovanÃ­ tÃ©to vlastnosti se nedoporuÄuje, protoÅ¾e Å¡patnÃ© nastavenÃ­ mÅ¯Å¾e vÃ©st k~nenaÄtenÃ­ operaÄnÃ­ho systÃ©mu.

NÃ¡sledujÃ­cÃ­ pÅ™Ã­kaz umoÅ¾Åˆuje administrÃ¡torovi vypsat vÅ¡echny vlastnosti danÃ©ho poolu. Pro struÄnost jsou vybrÃ¡ny pouze zÃ¡kladnÃ­ vlastnosti.
\begin{verbatim}
# zpool get all rpool
NAME   PROPERTY       VALUE                SOURCE
rpool  allocated      11.9G                -
rpool  bootfs         rpool/ROOT/solaris   local
rpool  capacity       38%                  -
rpool  dedupratio     1.19x                -
rpool  free           18.9G                -
rpool  health         ONLINE               -
rpool  readonly       off                  -
rpool  size           30.8G                -
\end{verbatim}

\subsection{VytvÃ¡Å™enÃ­ poolu}
Pool mÅ¯Å¾eme v~systÃ©mu ZFS kdykoli dynamicky vytvoÅ™it bez potÅ™eby zÃ¡sahu do operaÄnÃ­ho systÃ©mu. StaÄÃ­ mÃ­t k~dispozici potÅ™ebnÃ© zdroje (disk, partition, soubor) k~vytvoÅ™enÃ­ nÃ¡mi poÅ¾adovanÃ©ho poolu. Pokud mÃ¡me poÅ¾adovanÃ© zdroje, vybereme unikÃ¡tnÃ­ jmÃ©no pro pool v~kontextu ZFS a provedeme napÅ™Ã­klad nÃ¡sledujÃ­cÃ­ pÅ™Ã­kaz.
\begin{verbatim}
# zpool create tank c1t2d0 c2t1d0
\end{verbatim}
V~pÅ™Ã­padÄ› dostupnosti diskÅ¯ c1t2d0 a c2t1d0, tento pÅ™Ã­kaz vytvoÅ™Ã­ pool jmÃ©nem \verb|tank|, do kterÃ©ho tyto disky pÅ™iÅ™adÃ­. VÃ½slednÃ¡ velikost bude souÄtem velikostÃ­ tÄ›chto diskÅ¯. Takto vytvoÅ™enÃ½ pool neobsahuje Å¾Ã¡dnou redundanci a v~pÅ™Ã­padÄ› selhÃ¡nÃ­ disku, mÅ¯Å¾e dojÃ­t ke ztrÃ¡tÄ› dat. DruhÃ½m typem, kterÃ© ZFS podporuje, jsou redundantnÃ­ pooly.
\subsection{ZrcadlenÃ­}
PrvnÃ­m druhem redundantnÃ­ch poolÅ¯ jsou ty, kterÃ© obsahujÃ­ virtuÃ¡lnÃ­ zaÅ™Ã­zenÃ­ \emph{mirror} nebo-li zrcadlenÃ­. Tento typ virtuÃ¡lnÃ­ho zaÅ™Ã­zenÃ­ mÅ¯Å¾eme pomocÃ­ ZFS vytvoÅ™it nad dvÄ›ma a vÃ­ce zaÅ™Ã­zenÃ­mi. UvnitÅ™ zaÅ™Ã­zenÃ­ dochÃ¡zÃ­ k~replikaci dat na vÅ¡echny disky v~zaÅ™Ã­zenÃ­. VÃ½slednÃ¡ kapacita virtuÃ¡lnÃ­ho zaÅ™Ã­zenÃ­ je tedy rovna kapacitÄ› jednoho disku. Pokud zrcadlenÃ­ vytvoÅ™Ã­me nad tÅ™emi disky, nakonec budou data na vÅ¡ech tÅ™ech discÃ­ch stejnÃ¡ a v~pÅ™Ã­padÄ› vÃ½padku dvou z~nich o~data nepÅ™ijdeme. JinÃ¡ situace je samozÅ™ejmÄ› v~pÅ™Ã­padÄ› vÃ½padku vÅ¡ech tÅ™Ã­ diskÅ¯ najednou. ZrcadlenÃ­ nÃ¡m v~tomto pÅ™Ã­padÄ› nepomÅ¯Å¾e a vÅ¡echny data ztratÃ­me. NicmÃ©nÄ› pravdÄ›podobnost, Å¾e dojde k~vÃ½padku vÅ¡ech tÅ™Ã­ diskÅ¯ najednou je malÃ¡.

NÃ¡sledujÃ­cÃ­ pÅ™Ã­kaz demonstruje vytvoÅ™enÃ­ poolu s~redundantnÃ­m zaÅ™Ã­zenÃ­m \emph{mirror} o~tÅ™ech discÃ­ch.
\begin{verbatim}
# zpool create Pool mirror c1t1d0 c1t2d0 c2t1d0
\end{verbatim}

\subsection{Raidz}
DruhÃ½m typem redundantnÃ­ch poolÅ¯, kterÃ© ZFS umoÅ¾Åˆuje vytvÃ¡Å™et, jsou pooly obsahujÃ­cÃ­ virtuÃ¡lnÃ­ zaÅ™Ã­zenÃ­ \emph{raidz}. Toto virtuÃ¡lnÃ­ zaÅ™Ã­zenÃ­ vyuÅ¾Ã­vÃ¡ jednoho nebo vÃ­ce paritnÃ­ch diskÅ¯, kterÃ© nÃ¡m v~pÅ™Ã­padÄ› vÃ½padku nÄ›jakÃ©ho disku umoÅ¾nÃ­ dopoÄÃ­tat ztracenÃ¡ data. Podle poÄtu paritnÃ­ch diskÅ¯ nÃ¡m ZFS umoÅ¾Åˆuje vytvÃ¡Å™et nÃ¡sledujÃ­cÃ­ typy zaÅ™Ã­zenÃ­:
\begin{itemize}
  \item \emph{raidz1} - stripovÃ¡nÃ­ s~jednÃ­m paritnÃ­m diskem
  \item \emph{raidz2} - stripovÃ¡nÃ­ se dvÄ›ma paritnÃ­mi disky
  \item \emph{raidz3} - stripovÃ¡nÃ­ se tÅ™emi paritnÃ­mi disky
\end{itemize}

ZÃ¡pis dat na disk se provÃ¡dÃ­ v~pevnÄ› stanovenÃ½ch jednotkÃ¡ch tzv. stripech. Jeden stripe je rovnomÄ›rnÄ› rozprostÅ™en po vÅ¡ech datovÃ½ch discÃ­ch virtuÃ¡lnÃ­ho zaÅ™Ã­zenÃ­ \emph{raidz}. Pokud bychom tedy zapisovali na disky soubor, kterÃ½ by mÄ›l pÅ™esnÄ› velikost stripu, soubor bude rovnomÄ›rnÄ› rozprostÅ™en na vÅ¡ech discÃ­ch. Pokud by doÅ¡lo k~vÃ½padku jednoho disku z~virtuÃ¡lnÃ­ho zaÅ™Ã­zenÃ­, dojde tÃ­m i k~poÅ¡kozenÃ­ urÄitÃ© ÄÃ¡sti souboru a nebude moÅ¾nÃ© tyto data pÅ™eÄÃ­st. Pro tento ÃºÄel se vyuÅ¾Ã­vÃ¡ paritnÃ­ch diskÅ¯. PÅ™i zÃ¡pisu stripu na disky se ze zapisovanÃ½ch dat vypoÄte jedna hodnota, kterÃ¡ se nÃ¡slednÄ› uloÅ¾Ã­ na paritnÃ­ disk. V~pÅ™Ã­padÄ› vÃ½padku jednoho disku z~virtuÃ¡lnÃ­ho zaÅ™Ã­zenÃ­, jsme schopni dopoÄÃ­tat chybÄ›jÃ­cÃ­ data z~hodnoty parity. ZtracenÃ¡ data jsme schopni dopoÄÃ­tat pouze v~pÅ™Ã­padÄ›, Å¾e v~jednom okamÅ¾iku vypadne maximÃ¡lnÄ› takovÃ½ poÄet datovÃ½ch diskÅ¯, jako mÃ¡me k~dispozici paritnÃ­ch diskÅ¯.

JelikoÅ¾ jsou data rovnomÄ›rnÄ› rozmÃ­stÄ›na na vÅ¡echny datovÃ© disky ve virtuÃ¡lnÃ­m zaÅ™Ã­zenÃ­, mÅ¯Å¾eme pÅ™i ÄtenÃ­ dat vyuÅ¾Ã­vat vÃ­ce diskÅ¯ najednou. TÃ­m dokÃ¡Å¾eme docÃ­lit vyÅ¡Å¡Ã­ rychlosti ÄtenÃ­.

NÃ¡sledujÃ­cÃ­ pÅ™Ã­kaz ukazuje, jak jednoduÅ¡e se dÃ¡ v~souborovÃ©m systÃ©mu ZFS vytvoÅ™it redundantnÃ­ pool typu \emph{raidz1}.
\begin{verbatim}
# zpool create Pool raidz1 c1t1d0 c1t2d0 c2t1d0 c2t2d0
\end{verbatim}

\subsection{RozÅ¡iÅ™ovÃ¡nÃ­ poolu}
VÃ½hodou architektury poolÅ¯ je moÅ¾nost dynamickÃ©ho pÅ™idÃ¡vÃ¡nÃ­ fyzickÃ½ch nebo virtuÃ¡lnÃ­ch zaÅ™Ã­zenÃ­ do poolu. TÃ­m zÃ­skÃ¡vÃ¡me moÅ¾nost dynamickÃ©ho rozÅ¡iÅ™ovÃ¡nÃ­ kapacity celÃ©ho poolu, kterÃ¡ u~tradiÄnÃ­ch souborovÃ½ch systÃ©mu byla komplikovanÃ¡ (nutnost pouÅ¾itÃ­ VM) nebo nebyla dostupnÃ¡ vÅ¯bec. SouborovÃ© systÃ©my v~ZFS, kterÃ© jsou vytvoÅ™enÃ© nad stejnÃ½m poolem, sdÃ­lejÃ­ jeho prostÅ™edky, a proto pÅ™i rozÅ¡iÅ™ovÃ¡nÃ­ kapacity tohoto poolu budou mÃ­t k~dispozici vÃ­ce mÃ­sta pro uklÃ¡dÃ¡nÃ­ dat.

V~pÅ™Ã­padÄ› neredundantnÃ­ch poolÅ¯, kterÃ© neobsahujÃ­ virtuÃ¡lnÃ­ zaÅ™Ã­zenÃ­ typu \emph{mirror} nebo \emph{raidz}, mÅ¯Å¾eme pro rozÅ¡Ã­Å™enÃ­ pouÅ¾Ã­t soubor, disk nebo ÄÃ¡st disku (partition). ZFS nÃ¡m pro tento ÃºÄel nabÃ­zÃ­ pÅ™Ã­kaz \verb|zfs add|, kterÃ½m mÅ¯Å¾eme dynamicky pool rozÅ¡iÅ™ovat.

Pokud pool obsahuje redundantnÃ­ zaÅ™Ã­zenÃ­ \emph{mirror} nebo \emph{raidz}, je doporuÄenÃ© pool rozÅ¡iÅ™ovat pouze o~stejnÃ½ typ zaÅ™Ã­zenÃ­. Pokud se do poolu typu \emph{mirror} pokusÃ­me pÅ™idat virtuÃ¡lnÃ­ zaÅ™Ã­zenÃ­ \emph{raidz}, ZFS nÃ¡m vypÃ­Å¡e varovnou hlÃ¡Å¡ku.

VyuÅ¾itÃ­ souboru jako zdroje pro ZFS pool se v~praxi tÃ©mÄ›Å™ nevyuÅ¾Ã­vÃ¡. ZnamenÃ¡ to pÅ™idÃ¡nÃ­ dalÅ¡Ã­ vrstvy mezi ZFS a samotnÃ½ zdroj dat. HlavnÃ­ nevÃ½hodou tohoto zpÅ¯sobu je znaÄnÃ© zpomalenÃ­ procesu ÄtenÃ­ a zÃ¡pisu dat, ale na druhou stranu se tato volba vÃ½bornÄ› hodÃ­ pro testovÃ¡nÃ­ funkcÃ­ souborovÃ©ho systÃ©mu ZFS.

\subsection{ZruÅ¡enÃ­ poolu}
StejnÄ› jako mÅ¯Å¾eme dynamicky pool vytvÃ¡Å™et a rozÅ¡iÅ™ovat, mÅ¯Å¾eme pool i kdykoli zniÄit a uvolnit tak prostÅ™edky, kterÃ© vyuÅ¾Ã­val. Tyto prostÅ™edky jsou ihned k~dispozici a mÅ¯Å¾eme z~nich vytvoÅ™it novÃ½ pool. JelikoÅ¾ vÅ¡echny souborovÃ© systÃ©my vytvoÅ™enÃ© nad poolem sdÃ­lejÃ­ jeho prostÅ™edky, jsou tyto souborovÃ© systÃ©my zniÄeny spolu s~tÃ­mto poolem. Ke zniÄenÃ­ poolu, kterÃ½ jsme dÅ™Ã­ve vytvoÅ™ili, mÅ¯Å¾eme pouÅ¾Ã­t nÃ¡sledujÃ­cÃ­ pÅ™Ã­kaz.
\begin{verbatim}
# zpool -r destroy tank
\end{verbatim}
Pokud v~systÃ©mu existuje pool jmÃ©nem \verb|tank|, pÅ™Ã­kaz ho zniÄÃ­ bez ohledu na to, kolik souborovÃ½ch systÃ©mu nad tÃ­mto poolem bylo vytvoÅ™eno.

\section{SouborovÃ½ systÃ©m}
DruhÃ½m ze stavebnÃ­ch kamenÅ¯ ZFS jsou samotnÃ© souborovÃ© systÃ©my. Jak bylo zmÃ­nÄ›no v~kapitole \ref{fs}, souborovÃ½ systÃ©m je zpÅ¯sob organizace dat do souborÅ¯ v~datovÃ½ch ÃºloÅ¾iÅ¡tÃ­ch.
TradiÄnÃ­ souborovÃ© systÃ©my vyuÅ¾Ã­vajÃ­ k~organizaci rÅ¯znÃ½ch datovÃ½ch struktur. NÄ›kterÃ© systÃ©my vyuÅ¾Ã­vajÃ­ tzv. inodÅ¯, coÅ¾ je datovÃ¡ struktura drÅ¾Ã­cÃ­ atributy souboru a ukazatele na jednotlivÃ© datovÃ© bloky \cite{fs}. SouborovÃ½ systÃ©m FAT k~organizaci dat vyuÅ¾Ã­vÃ¡ tzv. file allocation table \cite{fs}. ZFS k~tomuto ÃºÄelu vyuÅ¾Ã­vÃ¡ stromovÃ© datovÃ© struktury, kterÃ¡ je znÃ¡zornÄ›na na obrÃ¡zku \ref{structure}. JednÃ¡ se v~podstatÄ› o~systÃ©m odkazÅ¯, kterÃ½ zÃ¡roveÅˆ udrÅ¾uje informace o~souborech a adresÃ¡Å™Ã­ch. Bloky s~daty se nachÃ¡zejÃ­ v~listech stromu.
\begin{figure}
    \centering
    \includegraphics[scale=0.8]{zfsstructure.pdf}
    \caption{Struktura souborovÃ©ho systÃ©mu ZFS}
    \label{structure}
\end{figure}

Tato stromovÃ¡ struktura pÅ™inÃ¡Å¡Ã­ zajÃ­mavÃ© vÃ½hody, kterÃ© budou podrobnÄ›ji popsÃ¡ny v~dalÅ¡Ã­ch kapitolÃ¡ch.

\subsection{Hierarchie souborovÃ½ch systÃ©mÅ¯}
\label{hiararchy}
Jednou z~vlastnostÃ­ ZFS je moÅ¾nost hierarchickÃ©ho vnoÅ™ovÃ¡nÃ­ souborovÃ½ch systÃ©mÅ¯ do sebe. Pool se sÃ¡m chovÃ¡ jako souborovÃ½ systÃ©m, a proto uÅ¾ pÅ™i vytvÃ¡Å™enÃ­ souborovÃ©ho systÃ©mu uvnitÅ™ poolu dochÃ¡zÃ­ k~hierarchickÃ©mu vnoÅ™ovÃ¡nÃ­. PÅ™esvÄ›dÄit se o~tom mÅ¯Å¾eme pomocÃ­ nÃ¡sledujÃ­cÃ­ho pÅ™Ã­kazu, kterÃ©mu mÃ­sto jmÃ©na souborovÃ©ho systÃ©mu pÅ™edÃ¡me jmÃ©no poolu. Pokud pÅ™Ã­kaz probÄ›hne dobÅ™e, vypÃ­Å¡e zÃ¡kladnÃ­ informace o~souborovÃ©m systÃ©mu.
\begin{verbatim}
# zfs list rpool
NAME    USED  AVAIL  REFER  MOUNTPOINT
rpool  12.1G  18.2G  4.85M  /rpool
\end{verbatim}
Pokud by zmÃ­nÄ›nÃ½ souborovÃ½ systÃ©m neexistoval, pÅ™Ã­kaz by vrÃ¡til chybovou hlÃ¡Å¡ku.

Pool tedy tvoÅ™Ã­ hlavnÃ­ uzel v~tÃ©to hierarchickÃ© posloupnosti a vÅ¡echny souborovÃ© systÃ©my vytvoÅ™enÃ© nad tÃ­mto poolem jsou jeho potomkem. V~jednom poolu mÅ¯Å¾eme vytvoÅ™it vÃ­ce souborovÃ½ch systÃ©mÅ¯ a takÃ© je do sebe mÅ¯Å¾eme libovolnÄ› vnoÅ™ovat. NejlÃ©pe si mÅ¯Å¾eme tuto hierarchii souborovÃ½ch systÃ©mÅ¯ ukÃ¡zat na obrÃ¡zku \ref{fshierarchy}, kde mÅ¯Å¾eme vidÄ›t, jak se do sebe jednotlivÃ© souborovÃ© systÃ©my vnoÅ™ujÃ­.
\begin{figure}[b]
    \centering
    \includegraphics[scale=0.8]{hierarchy.pdf}
    \caption{Hierarchie souborovÃ½ch systÃ©mÅ¯ ZFS}
    \label{fshierarchy}
\end{figure}

\subsection{Vlastnosti souborovÃ©ho systÃ©mu}
StejnÄ› jako si ZFS udrÅ¾uje u~kaÅ¾dÃ©ho poolu jeho vlastnosti, tak si je takÃ© udrÅ¾uje u~kaÅ¾dÃ©ho souborovÃ©ho systÃ©mu. NastavovÃ¡nÃ­m tÄ›chto vlastnostÃ­ je administrÃ¡tor schopen urÄit specifickÃ© chovÃ¡nÃ­ konkrÃ©tnÃ­ho souborovÃ©ho systÃ©mu. V~kontextu ZFS mÃ¡ kaÅ¾dÃ½ souborovÃ½ systÃ©mu jednoznaÄnÃ½ identifikÃ¡tor, kterÃ½ je odvozen z~hierarchie souborovÃ½ch systÃ©mÅ¯. SklÃ¡dÃ¡ se z~nÃ¡zvu systÃ©mu a nÃ¡zvÅ¯ jeho rodiÄÅ¯. IdentifikÃ¡tor by mohl vypadat nÃ¡sledovnÄ› \emph{rpool/ROOT/solaris}.

Vlastnosti souborovÃ½ch systÃ©mÅ¯ mÅ¯Å¾eme rozdÄ›lit, stejnÄ› jako u~vlastnostÃ­ poolu, na dvÄ› kategorie. PrvnÃ­ kategoriÃ­ jsou vlastnosti, kterÃ© se dajÃ­ pouze ÄÃ­st. Velkou ÄÃ¡st tÃ©to skupiny tvoÅ™Ã­ vlastnosti popisujÃ­cÃ­ vyuÅ¾itÃ­ mÃ­sta v~souborovÃ©m systÃ©mu. PÅ™Ã­kladem mÅ¯Å¾e bÃ½t mÃ­sto spotÅ™ebovanÃ© vnoÅ™enÃ½mi souborovÃ½mi systÃ©my nebo souborovÃ½m systÃ©mem samotnÃ½m. V~tÃ©to skupinÄ› vlastnostÃ­ mÅ¯Å¾eme najÃ­t takÃ© datum vytvoÅ™enÃ­ nebo pomÄ›r deduplikace a komprese dat.

V~druhÃ© kategorii jsou vlastnosti, kterÃ© mÅ¯Å¾e administrÃ¡tor zmÄ›nit za bÄ›hu nebo pÅ™i vytvÃ¡Å™enÃ­ souborovÃ½ch systÃ©mÅ¯. StejnÄ› jako na Ãºrovni poolu, tak i na Ãºrovni souborovÃ©ho systÃ©mu, mÅ¯Å¾eme nastavit vlastnost \emph{read-only}, kterÃ¡ znemoÅ¾nÃ­ uÅ¾ivatelÅ¯m zapisovat nebo mÄ›nit data v~souborovÃ©m systÃ©mu. Za povÅ¡imnutÃ­ dÃ¡le stojÃ­ vlastnost \emph{exec}, kterÃ¡ dovoluje v~souborovÃ©m systÃ©mu spouÅ¡tÄ›t procesy.

AdministrÃ¡tor mÅ¯Å¾e jednoduÅ¡e zapÃ­nat, vypÃ­nat Äi mÄ›nit vlastnosti souborovÃ©ho systÃ©mu pomocÃ­ pÅ™Ã­kazu \verb|zfs set property=value rpool|, popÅ™Ã­padÄ› si zobrazit seznam vÅ¡ech dostupnÃ½ch vlastnostÃ­ o~souborovÃ©m systÃ©mu pomocÃ­ pÅ™Ã­kazu \verb|zfs get all rpool|.

\subsection{DÄ›diÄnost}
DÃ­ky hierarchickÃ© struktuÅ™e se dÃ¡ jednoduÅ¡e zjistit, kdo je pÅ™edkem danÃ©ho souborovÃ©ho systÃ©mu a kdo je jeho potomkem. VÅ¡echny nastavitelnÃ© vlastnosti, kromÄ› kvÃ³t a rezervacÃ­, se dÄ›dÃ­ od rodiÄovskÃ©ho souborovÃ©ho systÃ©mu. Pokud Å¾Ã¡dnÃ½ rodiÄ nemÃ¡ vlastnost nastavenou explicitnÄ›, je pouÅ¾ita standardnÃ­ hodnota \cite{inheriting}.

Pokud chceme explicitnÄ› Å™Ã­ci, aby nÄ›kterÃ¡ vlastnost byla pÅ™evzata od rodiÄe, mÅ¯Å¾eme pouÅ¾Ã­t pÅ™Ã­kaz \verb|zfs inherit property rpool|. Tento pÅ™Ã­kaz odnastavÃ­ danou vlastnost ze souborovÃ©ho systÃ©mu a pokusÃ­ se pÅ™evzÃ­t hodnotu z~rodiÄe. Pokud v~Å¾Ã¡dnÃ©m z~rodiÄÅ¯ nenÃ­ hodnota nastavena explicitnÄ›, je pouÅ¾ita standardnÃ­ hodnota \cite{inheriting}.
\subsection{VytvÃ¡Å™enÃ­ souborovÃ©ho systÃ©mu}
\label{createfs}
VytvÃ¡Å™enÃ­ souborovÃ½ch systÃ©mÅ¯ v~ZFS je velice jednoduchÃ©. JedinÃ© co potÅ™ebujeme k~vytvoÅ™enÃ­ souborovÃ©ho systÃ©mu je jednoznaÄnÃ½ identifikÃ¡tor. ZFS [R vytvoÅ™enÃ­ tÄ›chto systÃ©mÅ¯ pomocÃ­ pÅ™Ã­kazu \verb|zfs create pool|, kde \emph{pool} je 0. Pokud neexistujÃ­ vÅ¡ichni pÅ™edci, je potÅ™eba pouÅ¾Ã­t pÅ™epÃ­naÄ \verb|-p|, jinak pÅ™Ã­kaz selÅ¾e.

PÅ™i vytvÃ¡Å™enÃ­ je moÅ¾nÃ© specifikovat, kterÃ© vlastnosti danÃ½ souborovÃ½ systÃ©m bude mÃ­t. Mimo jinÃ© existujÃ­ vlastnosti, kterÃ© se dajÃ­ nastavit pouze pÅ™i vytvÃ¡Å™enÃ­. Po vytvoÅ™enÃ­ souborovÃ©ho systÃ©mu jsou tyto vlastnosti vedeny jako read-only a nedajÃ­ se zmÄ›nit. PÅ™Ã­kladem mÅ¯Å¾e bÃ½t vlastnost \emph{encryption}, kterÃ¡ umoÅ¾Åˆuje Å¡ifrovÃ¡nÃ­ souborovÃ©ho systÃ©mu pomocÃ­ rÅ¯znÃ½ch kryptografickÃ½ch funkcÃ­. Pro vyuÅ¾itÃ­ tÃ©to vlastnosti mÅ¯Å¾eme pÅ™i vytvÃ¡Å™enÃ­ poolu pouÅ¾Ã­t nÃ¡sledujÃ­cÃ­ pÅ™Ã­kaz.
\begin{verbatim}
# zfs create -o enryption=on tank/pool/pool
\end{verbatim}
\subsection{ZruÅ¡enÃ­ souborovÃ©ho systÃ©mu}
RuÅ¡enÃ­ souborovÃ½ch systÃ©mu je v~ZFS stejnÄ› snadnÃ© jako jejich vytvÃ¡Å™enÃ­. Je dÅ¯leÅ¾itÃ© mÃ­t na pamÄ›ti, Å¾e zruÅ¡enÃ­m souborovÃ©ho systÃ©mu, kterÃ½ mÃ¡ nÄ›jakÃ© potomky, zruÅ¡Ã­me i vÅ¡echny vnoÅ™enÃ© souborovÃ© systÃ©my. Pro zruÅ¡enÃ­ souborovÃ©ho systÃ©mu jiÅ¾ staÄÃ­ pouÅ¾Ã­t pÅ™Ã­kaz \verb|zfs destroy| s~pÅ™Ã­sluÅ¡nÃ½m identifikÃ¡torem, popÅ™Ã­padÄ› pÅ™epÃ­naÄem \verb|-r| pro zruÅ¡enÃ­ vÅ¡ech potomkÅ¯.
\subsection{KvÃ³ty}
\label{quota}

KvÃ³ty v~ZFS umoÅ¾ÅˆujÃ­ administrÃ¡torovi spravovat limity souborovÃ½ch systÃ©mÅ¯ tÃ½kajÃ­cÃ­ch se vyuÅ¾itÃ©ho mÃ­sta. Tyto limity omezujÃ­ moÅ¾nosti vyuÅ¾itÃ­ dostupnÃ©ho mÃ­sta v~souborovÃ©m systÃ©mu. KvÃ³ty mÅ¯Å¾eme rozdÄ›lit do nÃ¡sledujÃ­cÃ­ch kategoriÃ­ podle toho, koho omezujÃ­:
\begin{itemize}
  \item ObecnÃ© - tÃ½kajÃ­cÃ­ se souborovÃ©ho systÃ©mu
  \item UÅ¾ivatelskÃ© - omezujÃ­ jednotlivÃ© uÅ¾ivatele
  \item SkupinovÃ© - omezujÃ­ celÃ© skupiny uÅ¾ivatelÅ¯
\end{itemize}

ObecnÃ© kvÃ³ty omezujÃ­ mÃ­sto, kterÃ© mÅ¯Å¾e souborovÃ½ systÃ©m vyuÅ¾Ã­t jako celek. K~tomuto ÃºÄelu v~ZFS slouÅ¾Ã­ vlastnost \emph{quota}, kterÃ¡ stanovuje limit mÃ­sta, kterÃ© mÅ¯Å¾e danÃ½ souborovÃ½ systÃ©m vyuÅ¾Ã­t. V~tomto pÅ™Ã­padÄ› se do vyuÅ¾itÃ©ho mÃ­sta zapoÄÃ­tÃ¡vÃ¡ i mÃ­sto spotÅ™ebovanÃ© potomky \cite{quotas}. Pokud bychom chtÄ›li omezit souborovÃ½ systÃ©m bez ohledu na to kolik mÃ­sta vyuÅ¾ijÃ­ jeho potomci, musÃ­me pouÅ¾Ã­t vlastnost \emph{refquota}.
%% Rezervace

Vzhledem k~faktu, Å¾e souborovÃ© systÃ©my v~jednom poolu sdÃ­lÃ­ diskovÃ© mÃ­sto, ZFS pÅ™ichÃ¡zÃ­ s~vlastnostÃ­ \emph{reservation}. Tato vlastnost oproti kvÃ³tÃ¡m garantuje souborovÃ©mu systÃ©mu diskovÃ© mÃ­sto danÃ© velikosti \cite{quotas}. StejnÄ› jako v~pÅ™Ã­padÄ› vlastnosti \emph{quota} je toto mÃ­sto vyhrazeno pro souborovÃ½ systÃ©m a vÅ¡echny jeho potomky. Pokud bychom chtÄ›li garantovat mÃ­sto pÅ™Ã­mo souborovÃ©mu systÃ©mu, bez ohledu na to kolik mÃ­sta vyuÅ¾Ã­vajÃ­ jeho potomci, musÃ­me vyuÅ¾Ã­t vlastnost \emph{refreservation}.

JelikoÅ¾ vlastnosti \emph{quota} resp. \emph{refquota} a vlastnosti \emph{reservation} resp. \emph{refreservation} jsou vlastnostmi souborovÃ©ho systÃ©mu, mÅ¯Å¾eme je nastavit stejnÄ› jako kteroukoliv jinou vlastnost pomocÃ­ nÃ¡sledujÃ­cÃ­ch pÅ™Ã­kazÅ¯.
\begin{verbatim}
# zfs set quota=10G rpool/export/home
# zfs set reservation=10G rpool/export/home
\end{verbatim}

Vztahy mezi vlastnostmi \emph{quota} a \emph{reservation} jsou vyznaÄeny na obrÃ¡zku \ref{quotavsreserv}.
%% ObrÃ¡zek
\begin{figure}
    \centering
    \includegraphics[scale=0.8]{quota.pdf}
    \caption{Vztahy mezi vlastnostmi \emph{quota} a \emph{reservation}}
    \label{quotavsreserv}
\end{figure}
%% UÅ¾ivatelskÃ© a skupinovÃ© kvÃ³ty

DÃ¡le mÅ¯Å¾eme omezit vyuÅ¾itÃ­ diskovÃ©ho mÃ­sta pomocÃ­ uÅ¾ivatelskÃ½ch resp. skupinovÃ½ch kvÃ³t. Tyto kvÃ³ty limitujÃ­ uÅ¾ivatele resp. skupinu v~tom, kolik mÃ­sta mÅ¯Å¾ou v~souborovÃ©m systÃ©mu vyuÅ¾Ã­t. KaÅ¾dÃ½ souborovÃ½ systÃ©m mÃ¡ svÅ¯j vlastnÃ­ \emph{userspace} resp. \emph{groupspace}, kde si udrÅ¾uje informace o~tom, jakÃ© majÃ­ limity jednotlivÃ© skupiny resp. uÅ¾ivatelÃ©.
AdministrÃ¡tor si mÅ¯Å¾e hodnoty uÅ¾ivatelskÃ½ch resp. skupinovÃ½ch kvÃ³t vypsat pomocÃ­ \verb|zfs userspace| resp. \verb|zfs groupspace|. NÃ¡sledujÃ­cÃ­ pÅ™Ã­kaz demonstruje, jak vypadÃ¡ vÃ½pis uÅ¾ivatelskÃ½ch kvÃ³t pro domovskÃ½ adresÃ¡Å™.
\begin{verbatim}
# zfs userspace rpool/export/home/simactom
TYPE        NAME       USED  QUOTA  SOURCE
POSIX User  root      1.50K   none  default
POSIX User  simactom   641M   none  default
\end{verbatim}

Pokud se uÅ¾ivatel resp. skupina v~seznamu nenachÃ¡zÃ­ nebo je u~nÄ›j uvedena hodnota \emph{none}, uÅ¾ivatelskÃ© resp. skupinovÃ© kvÃ³ty se na nÄ›j nevztahujÃ­. Je-li v~seznamu uvedena jinÃ¡ hodnota, pak uÅ¾ivatel v~danÃ©m souborovÃ©m systÃ©mu nesmÃ­ pÅ™ekroÄit tuto hodnotu. Pokud by tuto hodnotu pÅ™ekroÄil, systÃ©m ho varuje a poÅ¾adovanou akci neprovede. PÅ™iÅ™azenÃ­ kvÃ³ty uÅ¾ivateli resp. skupinÄ› provedeme pomocÃ­ nÃ¡sledujÃ­cÃ­ch pÅ™Ã­kazÅ¯:
\begin{verbatim}
# zfs userquota@username=value filesystem
# zfs groupquota@username=value filesystem
\end{verbatim}

ZFS nabÃ­zÃ­ jeÅ¡tÄ› vlastnost \emph{defaultuserquota} resp. \emph{defaultgroupquota}, kterou lze nastavit na urÄitou hodnotu. Tento limit se pouÅ¾ije v~pÅ™Ã­padÄ›, Å¾e hodnotu uÅ¾ivatelskÃ© resp. skupinovÃ© kvÃ³ty nastavÃ­me na hodnotu \emph{default}.
\section{Deduplikace}
\label{dedup}
Jednou z~dalÅ¡Ã­ vlastnostÃ­, kterÃ© ZFS nabÃ­zÃ­, je deduplikace. Jak jiÅ¾ z~nÃ¡zvu vyplÃ½vÃ¡, jednÃ¡ se o~proces, kterÃ½ zabraÅˆuje duplikaci stejnÃ½ch dat na disku a tÃ­m Å¡etÅ™Ã­ i mÃ­sto. Deduplikace se obecnÄ› dÃ¡ rozdÄ›lit na nÃ¡sledujÃ­cÃ­ ÃºrovnÄ›:
\begin{itemize}
  \item ÃšroveÅˆ souborÅ¯
  \item ÃšroveÅˆ 2 blokÅ¯
  \item ÃšroveÅˆ bajtÅ¯
\end{itemize}

K~identifikaci stejnÃ½ch dat se v~ZFS vyuÅ¾Ã­vÃ¡ haÅ¡ovacÃ­ funkce. Z~porovnÃ¡vanÃ½ch dat jsou vytvoÅ™eny haÅ¡e, kterÃ© jsou nÃ¡slednÄ› porovnÃ¡ny. Pokud se haÅ¡e rovnajÃ­ a pouÅ¾Ã­vÃ¡me kvalitnÃ­ haÅ¡ovacÃ­ funkci, mÅ¯Å¾eme s~velkou pravdÄ›podobnostÃ­ Å™Ã­ci, Å¾e jsou porovnÃ¡vanÃ¡ data opravdu totoÅ¾nÃ¡ \cite{dedup}. Pokud je administrÃ¡tor z~nÄ›jakÃ©ho dÅ¯vodu stÃ¡le nedÅ¯vÄ›Å™ivÃ½, mÅ¯Å¾e u~vlastnosti deduplikace nastavit hodnotu \emph{verify}, kterÃ¡ zajistÃ­ celkovÃ© porovnÃ¡nÃ­ datovÃ½ch ÄÃ¡stÃ­ bajt po bajtu.

Deduplikace na Ãºrovni souborÅ¯ vyuÅ¾Ã­vÃ¡ nejmÃ©nÄ› systÃ©movÃ½ch prostÅ™edkÅ¯, protoÅ¾e se data haÅ¡ujÃ­ a porovnÃ¡vajÃ­ po velkÃ½ch ÄÃ¡stech. Na druhou stranu sebemenÅ¡Ã­ zmÄ›na v~souboru vyÅ¾aduje pÅ™epoÄÃ­tÃ¡nÃ­ haÅ¡e, kterÃ½ se jiÅ¾ bude liÅ¡it od pÅ¯vodnÃ­ho \cite{dedup}. SouborovÃ½ systÃ©m pak rozpoznÃ¡, Å¾e se soubory liÅ¡Ã­ a uspoÅ™enÃ© mÃ­sto bude zaplnÄ›no zmÄ›nÄ›nÃ½m souborem.

Deduplikace datovÃ½ch blokÅ¯ vyÅ¾aduje oproti deduplikaci souborÅ¯ vyÅ¡Å¡Ã­ vyuÅ¾itÃ­ systÃ©movÃ½ch prostÅ™edkÅ¯, ale na druhou stranu pÅ™inÃ¡Å¡Ã­ v~jistÃ½ch situacÃ­ch lepÅ¡Ã­ Ãºsporu mÃ­sta \cite{dedup}.

V~poslednÃ­ Å™adÄ› existuje deduplikace na Ãºrovni bajtÅ¯, kterÃ¡ je ze vÅ¡ech uvedenÃ½ch ÃºrovnÃ­ nejnÃ¡roÄnÄ›jÅ¡Ã­ na vyuÅ¾itÃ­ vÃ½poÄetnÃ­ch prostÅ™edkÅ¯. Tato moÅ¾nost se pouÅ¾Ã­vÃ¡ jen ve speciÃ¡lnÃ­ch pÅ™Ã­padech.

ZFS z~vÃ½Å¡e uvedenÃ½ch moÅ¾nostÃ­ nabÃ­zÃ­ prÃ¡vÄ› deduplikaci na Ãºrovni datovÃ½ch blokÅ¯, protoÅ¾e tato jednotka deduplikace pÅ™inÃ¡Å¡Ã­ nejvÃ­ce vÃ½hod v~obecnÃ½ch pÅ™Ã­padech pouÅ¾itÃ­ \cite{dedup}. Na obrÃ¡zku \ref{blockdedup} mÅ¯Å¾eme vidÄ›t porovnÃ¡nÃ­ souborovÃ©ho systÃ©mu pÅ™i zapnutÃ© a vypnutÃ© vlastnosti deduplikace.
\begin{figure}
    \includegraphics[scale=0.8]{dedup.pdf}
    \caption{UkÃ¡zka 0 na Ãºrovni datovÃ½ch blokÅ¯}
    \label{blockdedup}
\end{figure}
\section{Konzistence}
\label{consitence}
StarÅ¡Ã­ souborovÃ© systÃ©my zapisujÃ­ data pÅ™Ã­mo do bloku, kterÃ½ mÄ›nÃ­. To mÅ¯Å¾e v~nÄ›kterÃ½ch pÅ™Ã­padech, jako je selhÃ¡nÃ­ systÃ©mu nebo vÃ½padek proudu, vÃ©st k~nekonzistenci souborovÃ©ho systÃ©mu. V~takovÃ©m pÅ™Ã­padÄ› je nutnÃ© celÃ½ souborovÃ½ systÃ©m zkontrolovat napÅ™Ã­klad pomocÃ­ pÅ™Ã­kazu \verb|fsck|. BohuÅ¾el ani tento nÃ¡stroj v~nÄ›kterÃ½ch pÅ™Ã­padech nedokÃ¡Å¾e nÄ›kterÃ© nekonzistence opravit \cite{transaction}.

NÄ›kterÃ© souborovÃ© systÃ©my vyuÅ¾Ã­vajÃ­ tzv. Å¾urnÃ¡lÅ¯ k~pomoci s~udrÅ¾ovÃ¡nÃ­ konzistence dat. Å½urnÃ¡l je speciÃ¡lnÃ­ zÃ¡znam, kam se uklÃ¡dajÃ­ informace o~tom, co a kde se bude mÄ›nit. Po provedenÃ­ popisovanÃ© akce se do Å¾urnÃ¡lu zapÃ­Å¡e, Å¾e danÃ¡ operace byla provedena. KdyÅ¾ systÃ©m zkolabuje v~jakÃ©mkoli kroku tohoto postupu, je moÅ¾nÃ© ho pÅ™i startu sytÃ©mu dostat do konzistentnÃ­ho stavu. K~tomuto ÃºÄelu se opÄ›t vyuÅ¾Ã­vÃ¡ nÃ¡stroj \verb|fsck|.

ZFS pÅ™ichÃ¡zÃ­ s~transakÄnÃ­m systÃ©mem a technikou copy on write. Tato technika zajiÅ¡Å¥uje neustÃ¡lou konzistenci souborovÃ©ho systÃ©mu i v~okamÅ¾iku vÃ½padku, a proto nenÃ­ tÅ™eba Å¾urnÃ¡lu. Data na disku nejsou nikdy pÅ™Ã­mo pÅ™episovÃ¡na \cite{transaction}.

Transakce mÅ¯Å¾e vypadat nÃ¡sledovnÄ›. Nejprve se vytvoÅ™Ã­ kopie blokÅ¯, kterÃ© majÃ­ bÃ½t zmÄ›nÄ›ny. V~tÄ›chto kopiÃ­ch dojde k~vlastnÃ­ zmÄ›nÄ› dat, zatÃ­mco pÅ¯vodnÃ­ data jsou stÃ¡le na disku a nejsou nijak zmÄ›nÄ›na. NÃ¡slednÄ› se zmÄ›nÃ­ potÅ™ebnÃ¡ metadata. V~poslednÃ­ Å™adÄ› se provede atomickÃ¡ operace, kterÃ¡ pÅ™ipojÃ­ vÄ›tev s~novÃ½mi resp. zmÄ›nÄ›nÃ½mi bloky do stromu souborovÃ©ho systÃ©mÅ¯. StarÃ¡ data jsou smazÃ¡na.

PrÅ¯bÄ›h transakce je naznaÄen na obrÃ¡zku \ref{cow}. CelÃ¡ transakce buÄ probÄ›hne v~poÅ™Ã¡dku nebo nebude pÅ™ijata vÅ¯bec. Pokud v~prÅ¯bÄ›hu transakce dojde k~vÃ½padku, celÃ½ souborovÃ½ systÃ©m zÅ¯stÃ¡vÃ¡ konzistentnÃ­, protoÅ¾e pÅ¯vodnÃ­ data jsou stÃ¡le na disku a nemohla se provÃ©st atomickÃ¡ operace, kterÃ¡ by pÅ™ipojila novÃ¡ data.
\begin{figure}
    \centering
    \includegraphics[scale=0.8]{cow.pdf}
    \caption{Demonstrace copy on write}
    \label{cow}
\end{figure}
\section{Integrita dat}
\label{checksum}
Od souborovÃ©ho systÃ©mu oÄekÃ¡vÃ¡me, Å¾e pÅ™i ÄtenÃ­ dat z~urÄitÃ©ho datovÃ©ho bloku z~disku, dostaneme data, kterÃ¡ do tohoto bloku byla dÅ™Ã­ve zapsÃ¡na. Pokud tomu tak nenÃ­, mÄ›l by to souborovÃ½ systÃ©m detekovat a vrÃ¡tit chybu \cite{integrity1}.

Vlastnost neustÃ¡lÃ© konzistence souborovÃ©ho systÃ©mu ZFS zmÃ­nÄ›nÃ¡ vÃ½Å¡e v~kapitole \ref{consitence} zajiÅ¡Å¥uje, Å¾e chybnÃ¡ data se v~souborovÃ©m systÃ©mu mohou vyskytnout jen chybou hardwaru \cite{integrity2}.

ZFS dokÃ¡Å¾e tyto chyby detekovat pomocÃ­ tzv. kontrolnÃ­ch souÄtÅ¯. Tyto souÄty vznikajÃ­ a jsou pÅ™epoÄÃ­tÃ¡vÃ¡ny pÅ™i kaÅ¾dÃ© zmÄ›nÄ› bloku v~souborovÃ©m sytÃ©mu. Jak jsme mohli vidÄ›t na obrÃ¡zku \ref{structure}, souÄty nejsou uloÅ¾eny v~bloku, kterÃ©ho se tÃ½kajÃ­, ale v~bloku jemu nadÅ™azenÃ©m. PÅ™i kaÅ¾dÃ©m poÅ¾adavku na ÄtenÃ­ dojde k~vypoÄÃ­tÃ¡nÃ­ kontrolnÃ­ho souÄtu na zÃ¡kladÄ› dat, kterÃ¡ se v~souborovÃ©m systÃ©mu momentÃ¡lnÄ› nachÃ¡zÃ­ a potÃ© dojde k~porovnÃ¡nÃ­ vypoÄtenÃ©ho souÄtu se souÄtem uloÅ¾enÃ½m v~nadÅ™azenÃ©m bloku \cite{integrity1}. TÃ­m ZFS dokÃ¡Å¾e rozhodnout, zda je blok poÅ¡kozenÃ½ Äi nikoliv.

DÃ­ky tÄ›mto kontrolnÃ­m souÄtÅ¯m se souborovÃ½ systÃ©m dokÃ¡Å¾e v~urÄitÃ½ch situacÃ­ch sÃ¡m opravovat. Tato situace nastÃ¡vÃ¡ v~pÅ™Ã­padÄ›, Å¾e blok, pÅ™i jehoÅ¾ ÄtenÃ­ doÅ¡lo k~chybÄ›, je souÄÃ¡stÃ­ redundantnÃ­ho virtuÃ¡lnÃ­ho zaÅ™Ã­zenÃ­ \emph{raidz} nebo \emph{mirror}. V~tomto pÅ™Ã­padÄ› ZFS pÅ™eÄte datovÃ½ blok i z~replikovanÃ©ho disku nebo sestavÃ­ blok pomocÃ­ parity a nÃ¡slednÄ› opravÃ­ chybnÃ½ blok, pÅ™i jehoÅ¾ ÄtenÃ­ doÅ¡lo k~chybÄ›. Aplikace dostane sprÃ¡vnÃ¡ data i pÅ™es to, Å¾e pÅ¯vodnÄ› naÄtenÃ½ datovÃ½ blok byl poÅ¡kozenÃ½.

AÄkoliv dochÃ¡zÃ­ k~ovÄ›Å™ovÃ¡nÃ­ integrity dat automaticky pÅ™i kaÅ¾dÃ©m ÄtenÃ­ z~disku, je moÅ¾nÃ© tento proces manuÃ¡lnÄ› vyvolat a ovÄ›Å™it pomocÃ­ nÃ¡sledujÃ­cÃ­ sekvence pÅ™Ã­kazÅ¯:
\begin{verbatim}
# zpool scrub pool
# zpool status pool
pool: pool
state: ONLINE
scan: scrub repaired 0 in 6s with 0 errors
\end{verbatim}

\section{Mountpoint}
\label{mountpoint}
0 je jednou ze zÃ¡kladnÃ­ch vlastnostÃ­ vÅ¡ech souborovÃ½ch systÃ©mÅ¯. Je to vlastnÄ› cesta k~bodu v~adresÃ¡Å™ovÃ©m stromu operaÄnÃ­ho systÃ©mu, kde mÃ¡ bÃ½t danÃ½ souborovÃ½ systÃ©m pÅ™ipojen.

JelikoÅ¾ se ZFS snaÅ¾Ã­ administrÃ¡torÅ¯m maximÃ¡lnÄ› ulehÄit prÃ¡ci, starÃ¡ se o~automatickÃ© pÅ™ipojovÃ¡nÃ­ souborovÃ½ch systÃ©mÅ¯ sÃ¡m. K~ÃºÄelÅ¯m pÅ™ipojovÃ¡nÃ­ souborovÃ½ch systÃ©mÅ¯ v~ZFS slouÅ¾Ã­ jejich vlastnost \emph{mountpoint}, kde administrÃ¡tor mÅ¯Å¾e specifikovat, kam se mÃ¡ danÃ½ souborovÃ½ systÃ©m pÅ™ipojit. Pokud administrÃ¡tor tuto vlastnost explicitnÄ› neurÄÃ­, je odvozena od vlastnosti rodiÄovskÃ©ho souborovÃ©ho systÃ©mu.

Pro pÅ™ipojovÃ¡nÃ­ souborovÃ½ch systÃ©mÅ¯ ZFS se dajÃ­ pouÅ¾Ã­t i tradiÄnÃ­ nÃ¡stroje \emph{mount} a \emph{umount}. V~tradiÄnÃ­ch souborovÃ½ch systÃ©mech se pro automatickÃ© pÅ™ipojovÃ¡nÃ­ pouÅ¾Ã­val soubor \emph{/etc/vsfstab}, kde administrÃ¡tor specifikoval co a kam se mÃ¡ pÅ™ipojit. OperaÄnÃ­ systÃ©m po svÃ©m startu tento soubor zpracoval a vyznaÄenÃ© souborovÃ© systÃ©my automaticky pÅ™ipojil.

Pokud by administrÃ¡tor chtÄ›l vyuÅ¾Ã­vat tradiÄnÃ­ho pÅ™ipojovÃ¡nÃ­ pomocÃ­ souboru \emph{/etc/vsfstab}, je moÅ¾nÃ© nastavit vlastnost \emph{mountpoint} souborovÃ©ho systÃ©mu na hodnotu \emph{legacy} \cite{mountpoint}. TÃ­m administrÃ¡tor Å™ekne, Å¾e se o~souborovÃ½ systÃ©m bude starat sÃ¡m a ZFS ho jiÅ¾ automaticky pÅ™ipojovat nebude.
\section{Snapshot}
\label{snapshot}
ZFS snapshot je stav danÃ©ho souborovÃ©ho systÃ©mu v~Äase, kdy byl snapshot poÅ™Ã­zen. JednÃ¡ se o~read-only instanci danÃ©ho souborovÃ©ho systÃ©mu \cite{snapshot}.

DÃ­ky stromovÃ© architektuÅ™e souborovÃ©ho systÃ©mu ZFS je poÅ™izovÃ¡nÃ­ snapshotÅ¯ velice elegantnÃ­ a nenÃ¡roÄnÃ©. Pro vytvoÅ™enÃ­ mÅ¯Å¾eme pouÅ¾Ã­t pÅ™Ã­kaz \verb|zfs snapshot filesystem@snapshot|, kde \emph{filesystem} je jmÃ©no souborovÃ©ho systÃ©mÅ¯, jehoÅ¾ stav chceme zachytit a \emph{snapshot} je pojmenovÃ¡nÃ­ konkrÃ©tnÃ­ho stavu tohoto systÃ©mu.

Po provedenÃ­ pÅ™Ã­kazu si ZFS zapamatuje odkaz na vrchol souborovÃ©ho systÃ©mu, jehoÅ¾ snapshot tvoÅ™Ã­me. Tento odkaz se stane hlavnÃ­m koÅ™enem snapshotu jakoÅ¾to novÃ©ho souborovÃ©ho systÃ©mu. JelikoÅ¾ snapshot je souborovÃ½ systÃ©m urÄenÃ½ pouze ke ÄtenÃ­, nemÅ¯Å¾eme pomocÃ­ nÄ›j zmÄ›nit data v~aktivnÃ­m souborovÃ©m systÃ©mu. Po vytvoÅ™enÃ­ snapshotu je jeho velikost nulovÃ¡, protoÅ¾e se provedlo pouze zapamatovÃ¡nÃ­ odkazu a nebyly vytvoÅ™eny Å¾Ã¡dnÃ© kopie. Pokud se ovÅ¡em data v~aktivnÃ­m souborovÃ©m systÃ©mu zmÄ›nÃ­, je nutnÃ©, aby snapshot stÃ¡le odkazoval na starÃ¡ data. Toho docÃ­lÃ­me tak, Å¾e starÃ¡ data zkopÃ­rujeme a zvÄ›tÅ¡Ã­me tak velikost snapshotu \cite{snapshot}. Velikost snapshotu tedy zÃ¡visÃ­ na mnoÅ¾stvÃ­ zmÄ›nÄ›nÃ½ch dat od chvÃ­le, kdy byl vytvoÅ™en. Proces vytvÃ¡Å™enÃ­ snapshotu a rozÅ¡iÅ™ovÃ¡nÃ­ jeho velikosti je nÃ¡zornÄ› ukÃ¡zÃ¡n na obrÃ¡zku \ref{snapshotproces}.
\begin{figure}
    \centering
    \includegraphics[scale=0.8]{snapshot.pdf}
    \caption{VytvÃ¡Å™enÃ­ snapshotu}
    \label{snapshotproces}
\end{figure}

RekurzivnÃ­ tvorba snapshotÅ¯ se provÃ¡dÃ­ rychle pomocÃ­ jednÃ© atomickÃ© operace. Snapshoty jsou vytvoÅ™eny narÃ¡z vÅ¡echny dohromady nebo nejsou vytvoÅ™eny vÅ¯bec. VÃ½hodou atomickÃ© operace je fakt, Å¾e data ve vÅ¡ech snapshotech jsou konzistentnÃ­ vzhledem k~jednomu ÄasovÃ©mu okamÅ¾iku \cite{snapshot}.

Snapshot pro souborovÃ½ systÃ©m a vÅ¡echny jeho potomky mÅ¯Å¾eme vytvoÅ™it a ovÄ›Å™it jeho existenci pomocÃ­ nÃ¡sledujÃ­cÃ­ch pÅ™Ã­kazÅ¯:
\begin{verbatim}
# zfs snapshot -r rpool/export/home@snap
# zfs list -t snapshot -r rpool/export/home
NAME                             USED  AVAIL  REFER  MOUNTPOINT
rpool/export/home@snap              0      -    33K  -
rpool/export/home/simactom@snap     0      -   641M  -
\end{verbatim}
DruhÃ½ pÅ™Ã­kaz v~poÅ™adÃ­ ukazuje skuteÄnost, Å¾e snapshoty byly opravdu vytvoÅ™eny i pro vÅ¡echny potomky danÃ©ho souborovÃ©ho systÃ©mu a Å¾e jejich velikost je opravdu nulovÃ¡.

Snapshot se dÃ¡ pouÅ¾Ã­t k~navrÃ¡cenÃ­ souborovÃ©ho systÃ©mu do stavu, v~jakÃ©m se nachÃ¡zel v~okamÅ¾iku vytvoÅ™enÃ­ snapshotu. VeÅ¡kerÃ© zmÄ›ny, kterÃ© probÄ›hly v~souborovÃ©m systÃ©mu od okamÅ¾iku vytvoÅ™enÃ­ snapshotu budou smazÃ¡ny. K~vyvolÃ¡nÃ­ tohoto procesu staÄÃ­ pouÅ¾Ã­t pÅ™Ã­kaz \verb|zfs rollback snapshot|, kde \emph{snapshot} je celÃ© jmÃ©no snapshotu. JelikoÅ¾ se kaÅ¾dÃ½ snapshot vÃ¡Å¾e pÅ™Ã­mo s~urÄitÃ½m souborovÃ½m systÃ©mem, nenÃ­ tÅ™eba zadÃ¡vat jmÃ©no souborovÃ©ho systÃ©mu, kterÃ½ chceme navrÃ¡tit do pÅ¯vodnÃ­ho stavu. 